# 技術的実装詳細設計書

## プロジェクト概要
- プロジェクト名: 2.5vStream Atlier るりのね
- 技術スタック: Astro + CloudFlare Workers
- 更新日: 2025-11-15

## システム構成

### アーキテクチャ概要
```
[ユーザー] → [CloudFlare CDN] → [サブドメイン別Workers] → [外部API/サービス]
                                          ↓
                                    [CloudFlare D1 Database]
                                          ↓
                                   [Google OAuth API]
```

### サブドメイン構成
```
www.rurinone.ink      → Public Worker  (Astro SSG + SSR)
community.rurinone.ink → Community Worker (Astro SSR + 認証)
manage.rurinone.ink   → Operate Worker (Astro SSR + 管理認証)
```

### 技術スタック詳細
- **フロントエンド**: Astro Framework 5.10.1
- **ランタイム**: CloudFlare Workers (サブドメイン別)
- **データストレージ**: CloudFlare D1 (SQLite)
- **認証**: Google OAuth + 自作JWT
- **ドメイン**: rurinone.ink (マルチサブドメイン)
- **リポジトリ**: GitHub Monorepo (https://github.com/AkameLLC/rurinone)

## ページ別実装設計

### 1. トップページ (/)
#### 構成要素
- フルスクリーンキービジュアル
- Header/Navigation
- コミュニティ概要セクション
- 最新ニュース（3件程度）
- 配信者ピックアップ
- Footer

#### 実装ポイント
- キービジュアルはフルスクリーン表示
- レスポンシブデザイン対応
- SEO最適化（meta tags、structured data）

### 2. 配信者一覧ページ (/streamers)
#### 構成要素
- 配信者一覧（カード形式）
- 配信状態フィルタリング
- 検索機能

#### 実装ポイント
- 配信状態APIとの連携
- 無限スクロールまたはページネーション

### 3. 配信者詳細ページ (/streamers/[id])
#### 構成要素
- 配信者プロフィール
- 配信状態表示
- 外部リンク（X、配信サイト）
- 最新の配信履歴

### 4. ダッシュボード (/dashboard)
#### 構成要素
- 特典メニュー
- 配信補助ツール
- ナレッジページ
- アセットダウンロード

#### 実装ポイント
- 認証必須
- ユーザー権限管理

## データ構造設計

### CloudFlare D1 テーブル設計

#### 承認済みメールアドレス
```sql
CREATE TABLE approved_emails (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE NOT NULL,
  approved_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  approved_by TEXT,
  notes TEXT
);
```

#### ユーザーデータ
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY, -- GoogleのUser ID
  email TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  avatar_url TEXT,
  role TEXT DEFAULT 'member' CHECK(role IN ('member', 'admin')),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_login DATETIME,
  is_active BOOLEAN DEFAULT true
);
```

#### 配信者プロフィール
```sql
CREATE TABLE streamer_profiles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL REFERENCES users(id),
  display_name TEXT NOT NULL,
  description TEXT,
  avatar_url TEXT,
  twitter_handle TEXT,
  youtube_channel TEXT,
  twitch_channel TEXT,
  join_phase TEXT DEFAULT 'phase01' CHECK(join_phase IN ('phase01', 'phase02', 'phase03')),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 配信状態
```sql
CREATE TABLE stream_status (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  streamer_id INTEGER NOT NULL REFERENCES streamer_profiles(id),
  is_live BOOLEAN DEFAULT false,
  platform TEXT,
  title TEXT,
  viewer_count INTEGER,
  stream_url TEXT,
  last_updated DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### ニュース
```sql
CREATE TABLE news (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  content TEXT NOT NULL,
  excerpt TEXT,
  featured_image TEXT,
  published BOOLEAN DEFAULT false,
  created_by TEXT NOT NULL REFERENCES users(id),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### TypeScript型定義
```typescript
interface User {
  id: string
  email: string
  name: string
  avatar_url?: string
  role: 'member' | 'admin'
  created_at: string
  last_login?: string
  is_active: boolean
}

interface StreamerProfile {
  id: number
  user_id: string
  display_name: string
  description?: string
  avatar_url?: string
  twitter_handle?: string
  youtube_channel?: string
  twitch_channel?: string
  join_phase: 'phase01' | 'phase02' | 'phase03'
  created_at: string
  updated_at: string
}

interface StreamStatus {
  id: number
  streamer_id: number
  is_live: boolean
  platform?: string
  title?: string
  viewer_count?: number
  stream_url?: string
  last_updated: string
}
```

## API設計

### 認証API (全サブドメイン共通)
- `POST /api/auth/google` - Google OAuth認証
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - ユーザー情報取得
- `POST /api/auth/refresh` - トークンリフレッシュ

### Public API (www.rurinone.ink)
- `GET /api/streamers` - 配信者一覧取得
- `GET /api/streamers/:id` - 配信者詳細取得
- `GET /api/news` - 公開ニュース一覧
- `GET /api/news/:slug` - ニュース詳細
- `POST /api/contact` - 問い合わせ送信

### Community API (community.rurinone.ink)
- `GET /api/dashboard` - ダッシュボード情報
- `GET /api/knowledge` - ナレッジ一覧
- `GET /api/assets` - 素材ダウンロードリンク
- `GET /api/services` - 母体サービス情報

### Management API (manage.rurinone.ink)
- `GET /api/admin/users` - ユーザー一覧
- `POST /api/admin/users/:id/approve` - ユーザー承認
- `GET /api/admin/streamers` - 配信者管理
- `POST /api/admin/news` - ニュース作成
- `PUT /api/admin/news/:id` - ニュース更新
- `DELETE /api/admin/news/:id` - ニュース削除

## セキュリティ設計

### 認証・認可
- **Google OAuth 2.0**: 安全な認証フロー
- **事前承認システム**: approved_emailsテーブルでの制御
- **JWT トークン**: セッション管理
- **サブドメイン別認証**: 独立したセッション管理

### データ保護
- **CloudFlare D1**: 個人情報の暗号化
- **HTTPS必須**: 全サブドメインでSSL/TLS
- **CORS設定**: サブドメイン別の適切な設定
- **XSS対策**: CSP (Content Security Policy) 設定

### 管理画面セキュリティ
- **IP制限**: 管理者IPのみアクセス許可（オプション）
- **管理者権限**: roleベースのアクセス制御
- **セッション管理**: より短時間のセッションタイムアウト
- **監査ログ**: 管理操作の記録

## パフォーマンス最適化

### フロントエンド
- Astroの静的生成活用
- 画像最適化
- Critical CSS inline化

### バックエンド
- CloudFlare Workers Edge Computing
- KVストレージによる高速データアクセス
- APIレスポンスキャッシュ

## モノレポ構成

### ディレクトリ構造
```
rurinone/
├── apps/
│   ├── www/              # Public サイト (www.rurinone.ink)
│   │   ├── src/
│   │   ├── astro.config.mjs
│   │   └── wrangler.toml
│   ├── community/        # Community サイト (community.rurinone.ink)
│   │   ├── src/
│   │   ├── astro.config.mjs
│   │   └── wrangler.toml
│   └── manage/          # 管理画面 (manage.rurinone.ink)
│       ├── src/
│       ├── astro.config.mjs
│       └── wrangler.toml
├── packages/
│   ├── shared/          # 共通ライブラリ
│   │   ├── auth/        # 認証関連
│   │   ├── database/    # D1データベース操作
│   │   └── types/       # TypeScript型定義
│   └── ui-components/   # 共通UIコンポーネント
├── docs/
│   ├── 要件/
│   └── 設計/
└── tools/
    ├── database/        # D1マイグレーション
    └── deployment/      # デプロイスクリプト
```

### 開発・デプロイメント

#### 開発環境
```bash
# 全体の依存関係インストール
npm install

# 各サブドメインの開発サーバー起動
npm run dev:www        # Public サイト
npm run dev:community  # Community サイト  
npm run dev:manage     # 管理画面

# 全体ビルド
npm run build:all
```

#### デプロイメント
```bash
# 本番デプロイ
npm run deploy:www        # www.rurinone.ink
npm run deploy:community  # community.rurinone.ink
npm run deploy:manage     # manage.rurinone.ink

# 一括デプロイ
npm run deploy:all
```

### 環境変数 (各Workerで共通)
```
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
JWT_SECRET=your_jwt_secret_key
DATABASE_ID=your_d1_database_id
CLOUDFLARE_API_TOKEN=your_cloudflare_token
```

## コスト見積もり

### 月間コスト（500ユーザー想定）
- **CloudFlare Workers**: 無料枠内
- **CloudFlare D1**: 無料枠内
- **Google OAuth**: 無料
- **ドメイン**: 取得済み
- **SSL証明書**: CloudFlareで無料
- **合計**: 0円/月

### スケーラビリティ
- **1,000ユーザー**: $10〜15/月（D1従量課金）
- **2,000ユーザー**: $20〜30/月
- **企業レベル**: CloudFlare Proプラン検討 ($20/月)